<link rel="stylesheet" href="/gui/css/chat.css">

<div id="chat" class="section-profile">
    <div class="chat-popup form-container" id="myForm">
        <div id="chat-history">
            <ul id="chatter"></ul>
        </div>
        <input id="mymsg" type="text" placeholder="Type message.." name="msg"/>
        <button type="button" class="button-warn" onclick="closeForm()">Close</button>
    </div>
</div>

<li id="chat-line" style="display: none">
    <p id="chat-line-text"></p>
</li>

<script>
    let config = {{config|safe}};
    let chatWindow = $('#mymsg');

    let local = new WebSocket('ws://localhost:7012/chat');
    local.onmessage = function (s) {
        writeMessage(s.data);
    };

    chatWindow.keyup(function(e){
        if(e.keyCode === 13) {
            let message = chatWindow.val();
            config.teammates.forEach(function(ip) {
                let socket = new WebSocket('ws://'+ip+':7012/chat');
                socket.onopen = function () {
                    socket.send(message);
                };
            });
            writeMessage(message);
        }
    });

    function writeMessage(m) {
        let line = $("#chat-line").clone();
        line.find('#chat-line-text').html(m);
        line.show();
        $('#chatter').append(line);
        chatWindow.val('');
    }

    function closeForm(){
        document.getElementById("myForm").style.display = "none";
    }
</script>